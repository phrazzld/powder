# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Powder** is a project name manager - a full-stack web application for managing creative project names and tracking project metadata.

**Tech Stack:**
- **Frontend**: Next.js 16 (App Router), React 19, TypeScript, shadcn/ui (Radix), Tailwind CSS 4
- **Backend**: Convex (serverless database + realtime API)
- **Forms**: React Hook Form + Zod validation
- **Tables**: TanStack React Table
- **Package Manager**: pnpm 10.17.1

## Development Commands

```bash
# Frontend Development
pnpm dev                  # Start Next.js dev server (port 3000)
pnpm build               # Production build
pnpm start               # Start production server
pnpm lint                # Run Next.js linting

# Backend Development (Convex)
pnpm convex:dev          # Start Convex in dev mode (run in separate terminal)
pnpm convex:deploy       # Deploy to Convex production

# Standard Workflow
# Terminal 1: pnpm convex:dev
# Terminal 2: pnpm dev
```

**Environment:** Requires `NEXT_PUBLIC_CONVEX_URL` in `.env.local` (auto-generated by `convex dev`)

## Architecture

### High-Level Structure

```
powder/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/              # Next.js App Router pages
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ providers.tsx # ConvexProvider wrapper
â”‚   â”‚   â””â”€â”€ ui/          # shadcn/ui components
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ convex.ts    # ConvexReactClient singleton
â”‚       â”œâ”€â”€ validation.ts # Zod schemas
â”‚       â””â”€â”€ utils.ts     # cn() utility
â”‚
â””â”€â”€ convex/              # Backend (Convex)
    â”œâ”€â”€ schema.ts        # Database schema (names + projects)
    â”œâ”€â”€ names.ts         # NameManager module
    â”œâ”€â”€ projects.ts      # ProjectManager module
    â””â”€â”€ projectNameLinker.ts  # Cross-table linking
```

### Database Schema (Convex)

**Two core tables with rich indexing:**

**`names` table** - Name pool with state machine
- Fields: `name` (string), `status` (available|considering|assigned), `assignedTo` (project ID), `notes` (optional)
- Indexes: `by_name`, `by_status`, `by_project`
- Business rule: Names transition through state machine (see NameManager)

**`projects` table** - Project metadata
- Fields: `nameId` (assigned name), `consideringNameIds` (array), `status` (idea|active|paused|archived), `description`, `githubRepo`, `productionUrl`, `tags`, `createdAt`, `updatedAt`
- Indexes: `by_status`, `by_name`, `by_created`, `by_updated`
- Business rule: Ideas can have multiple considering names; active/paused/archived must have exactly one assigned name

### Backend Modules (Deep Modules Pattern)

**1. NameManager** (`convex/names.ts`)
- **Queries**: `listNames()`, `getAvailableNames()`, `getName()`
- **Mutations**: `createName()`, `updateNameNotes()`, `_transitionNameState()` (internal)
- **Responsibility**: Name lifecycle management + state machine enforcement
- **State Machine**: available â†’ considering â†’ assigned (and back to available)
- Enforces name uniqueness (throws ConvexError on duplicate)

**2. ProjectManager** (`convex/projects.ts`)
- **Queries**: `listProjects()` (with filtering/search/sort), `getProject()` (enriched), `getProjectStats()`
- **Mutations**: `createProject()`, `updateProject()`, `deleteProject()`
- **Responsibility**: Project CRUD + business rule validation + data enrichment
- Enriches projects with name data via joins (nameId â†’ name string)
- Validates:
  - Status-dependent requirements (active/paused/archived require nameId)
  - GitHub repo format: `^[a-zA-Z0-9_-]+\/[a-zA-Z0-9_-]+$` (owner/repo)
  - Production URL format

**3. ProjectNameLinker** (`convex/projectNameLinker.ts`)
- **Mutations**: `linkNamesToProject()`, `updateProjectNames()`, `promoteIdeaToActive()`, `releaseProjectNames()`, `handleStatusChange()`
- **Responsibility**: Atomic cross-table operations + referential integrity
- Maintains bidirectional consistency: `names.assignedTo` â†” `projects.nameId`
- Implements complex transitions (e.g., promoting idea â†’ active releases unconsidered names)
- All operations are transaction-safe

### Data Flow Pattern

```
Frontend (React Hook Form)
    â†“ Zod validation
Convex Mutations (server-side validation)
    â†“ atomic operations
Database (Convex persistent storage)
    â†‘ realtime subscriptions
Convex Queries (with enrichment/joins)
    â†‘ useQuery hooks
Frontend (auto-updating UI)
```

### Validation Strategy

**Client-side** (`src/lib/validation.ts`):
- `projectFormSchema` with Zod
- Status-dependent refinement (active projects require nameId)
- GitHub repo regex, URL format validation
- Shared between forms and Convex for consistency

**Server-side** (Convex mutations):
- Re-validates all inputs (never trust client)
- Enforces database constraints (uniqueness, referential integrity)
- Throws `ConvexError` with clear messages

### Frontend Patterns

**Server Components** (pages):
- Use `preloadQuery()` for data fetching
- Pass preloaded data to client components
- Handle URL params for filtering/search

**Client Components** (UI):
- Use `useQuery()` / `useMutation()` hooks (Convex)
- React Hook Form for forms
- TanStack React Table for tables
- shadcn/ui for consistent styling

## Key Patterns & Conventions

### File Naming
- Convex modules: `camelCase.ts` (e.g., `projectNameLinker.ts`)
- React components: `kebab-case.tsx` (e.g., `project-form.tsx`)
- Pages: `page.tsx` (Next.js convention)

### Import Aliases (tsconfig.json)
- `@/*` â†’ `src/*` (e.g., `import { cn } from "@/lib/utils"`)
- Convex auto-generates types in `convex/_generated/`

### State Management
- **Server state**: Convex queries (realtime subscriptions)
- **Form state**: React Hook Form
- **No global client state** (yet) - prefer server-driven

### Error Handling
- Convex mutations throw `ConvexError` with descriptive messages
- Forms display inline validation errors
- Toast notifications for mutation success/failure (TODO: implement)

## Implementation Status (TODO.md)

**âœ… Completed (Phase 1 & 2 setup):**
- All three backend modules (NameManager, ProjectManager, ProjectNameLinker)
- Database schema with indexes
- Form validation schemas (Zod)
- Root layout with ConvexProvider
- All shadcn/ui components installed

**ðŸš§ In Progress (Phase 2 frontend):**
- Dashboard page with filters, search, stats
- ProjectForm component (status-dependent fields)
- Project CRUD pages (`/projects/new`, `/projects/[id]`)
- Project table with TanStack React Table

**ðŸ“‹ TODO (Phase 3):**
- Import script for data migration (57 projects, ~100 names)
- Toast notifications
- Loading states & skeletons
- Empty states
- Mobile responsiveness
- Unit tests (NameManager state transitions)
- Integration tests (project-name linking)
- Deployment to Vercel

## Critical Design Decisions

### Why Convex?
- Realtime subscriptions (automatic UI updates)
- TypeScript-first with codegen
- Serverless (no backend maintenance)
- ACID transactions for cross-table operations

### Why Three Backend Modules?
- **Separation of concerns**: Names, Projects, and Linking are distinct domains
- **Deep module principle**: Each hides complexity behind simple interface
- **Testability**: Can unit test each module independently
- **Maintainability**: Changes to name logic don't affect project logic

### Status-Dependent Form Fields
- **Problem**: Active projects require assigned name; ideas don't
- **Solution**: Form fields dynamically change based on status selection
- **Implementation**: Zod `.refine()` for conditional validation + React Hook Form `watch()`

### Name State Machine
- **Problem**: Prevent invalid name states (e.g., name assigned to two projects)
- **Solution**: Strict state transitions enforced by `_transitionNameState()`
- **States**: available â†’ considering â†’ assigned (with reverse transitions)

## Common Tasks

### Add New Convex Query
```typescript
// convex/moduleName.ts
export const queryName = query({
  args: { /* validator args */ },
  handler: async (ctx, args) => {
    // Use ctx.db.query() with indexes
    return await ctx.db.query("tableName")
      .withIndex("by_field", q => q.eq("field", args.value))
      .collect();
  }
});
```

### Add New Convex Mutation
```typescript
// convex/moduleName.ts
import { ConvexError } from "convex/values";

export const mutationName = mutation({
  args: { /* validator args */ },
  handler: async (ctx, args) => {
    // Validate inputs
    if (!args.value) {
      throw new ConvexError("Clear error message");
    }
    // Perform mutation
    await ctx.db.insert("tableName", { /* data */ });
  }
});
```

### Use Convex Hook in Client Component
```typescript
"use client";
import { useQuery, useMutation } from "convex/react";
import { api } from "@/../convex/_generated/api";

export function MyComponent() {
  const data = useQuery(api.moduleName.queryName, { arg: value });
  const mutate = useMutation(api.moduleName.mutationName);

  if (!data) return <div>Loading...</div>;

  return <button onClick={() => mutate({ arg: value })}>Action</button>;
}
```

### Add New shadcn Component
```bash
pnpm dlx shadcn@latest add component-name
# Auto-installs to src/components/ui/
```

## Testing Strategy

**Unit Tests** (Convex modules):
- Test state transitions in NameManager
- Test validation logic in ProjectManager
- Use `convexTest` utility for isolated testing

**Integration Tests** (cross-module):
- Test project creation with name assignment
- Test idea promotion (releases unconsidered names)
- Test referential integrity (deleting project releases name)

**Manual Testing Checklist**:
- [ ] Create project with status changes (idea â†’ active)
- [ ] Verify name state transitions correctly
- [ ] Test filters/search on dashboard
- [ ] Test form validation (invalid GitHub repo, missing required fields)
- [ ] Test delete with "release name" option

## Migration Notes

**Data Source**: `~/Development/codex/docs/projects.md` + `~/Development/codex/docs/project-names.md`
- 57 projects (active, paused, archived, ideas)
- ~100 names (assigned + available pool)

**Import Strategy** (TODO):
- Parse markdown tables
- Create names with correct status
- Create projects with enriched fields
- Link names via ProjectNameLinker
- Idempotent (safe to re-run)

## Gotchas & Known Issues

1. **Convex Dev Must Run First**: Frontend needs `NEXT_PUBLIC_CONVEX_URL` from `convex dev`
2. **pnpm Required**: Project uses pnpm 10.17.1 (not npm/yarn)
3. **React 19 + Next.js 16**: Bleeding edge - watch for compatibility issues
4. **Tailwind 4**: New major version - some class names may differ from v3
5. **No Tests Yet**: Backend logic fully implemented but untested (high risk)

## Design Philosophy

This codebase follows **modular design principles** (inspired by Ousterhout):
- **Deep modules**: Simple interface, powerful implementation (e.g., ProjectNameLinker hides atomic transaction complexity)
- **Information hiding**: Internal state machine logic not exposed (e.g., `_transitionNameState` is internal)
- **Strategic programming**: Invest in clean abstractions now for future velocity

**Avoid**:
- Shallow modules (interface â‰ˆ implementation complexity)
- Manager/Util/Helper naming (symptom of unclear abstractions)
- Leaky abstractions (implementation details in interfaces)

## Resources

- **Convex Docs**: https://docs.convex.dev
- **Next.js App Router**: https://nextjs.org/docs/app
- **shadcn/ui**: https://ui.shadcn.com
- **React Hook Form**: https://react-hook-form.com
- **Zod**: https://zod.dev

---

*Last updated: 2025-11-02*
*Status: Backend complete, frontend 50% complete*
